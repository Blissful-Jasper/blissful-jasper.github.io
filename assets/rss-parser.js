class RSSParser{constructor(){this.corsProxies=["https://api.allorigins.win/raw?url=","https://corsproxy.io/?","https://cors-anywhere.herokuapp.com/","https://api.codetabs.com/v1/proxy?quest="],this.currentProxyIndex=0,this.cache=new Map,this.cacheTimeout=36e5,this.debug=!0}log(...t){this.debug&&console.log("[RSS Parser]",...t)}warn(...t){this.debug&&console.warn("[RSS Parser]",...t)}async parseRSS(r,n=0){var s="rss_"+r,t=this.getCached(s);if(t)return this.log("Using cached data for "+r),t;let i=1e3*(n+1);var a=this.getRSSVariants(r);for(let e=0;e<a.length;e++){var o=a[e];try{this.log(`Fetching RSS from ${o} (variant ${e+1}/${a.length}, attempt ${n+1}/4)`);var c=this.corsProxies[this.currentProxyIndex%this.corsProxies.length];this.log("Using CORS proxy: "+c);let t=new AbortController;var l=setTimeout(()=>t.abort(),15e3),u=await fetch(c+encodeURIComponent(o),{signal:t.signal,headers:{Accept:"application/rss+xml, application/xml, text/xml, */*","User-Agent":"Mozilla/5.0 (compatible; RSS Reader)"}});if(clearTimeout(l),!u.ok)throw new Error(`HTTP ${u.status}: `+u.statusText);var h=await u.text();if(!h||h.length<100)throw new Error("RSS feed appears to be empty or invalid");if(h.toLowerCase().includes("<!doctype html")||h.toLowerCase().includes("<html"))throw new Error("Server returned HTML instead of RSS XML - possibly a server error or incorrect URL");var g=(new DOMParser).parseFromString(h,"text/xml"),m=g.querySelector("parsererror");if(m)throw new Error("XML parsing error: "+m.textContent);var d=g.querySelector("rss")||g.querySelector("channel"),p=g.querySelector("feed");if(!d&&!p)throw new Error("Document does not appear to be valid RSS or Atom feed");var y=this.extractArticles(g);if(!(0===y.length&&(this.warn("No articles found in RSS feed: "+o),e<a.length-1)))return this.setCache(s,y),this.log(`Successfully parsed ${y.length} articles from `+o),y;this.log("Trying next RSS variant...")}catch(t){if(this.warn(`Error parsing RSS variant ${e+1} (${o}):`,t.message),e<a.length-1)this.log("Trying next RSS variant...");else if(n<3)return(t.message.includes("Failed to fetch")||t.message.includes("HTTP2_PROTOCOL_ERROR")||"AbortError"===t.name)&&(this.currentProxyIndex=(this.currentProxyIndex+1)%this.corsProxies.length,this.log(`Switching to next CORS proxy (index: ${this.currentProxyIndex})`)),this.log(`All variants failed, retrying in ${i}ms...`),await new Promise(t=>setTimeout(t,i)),this.parseRSS(r,n+1)}}return console.error("All attempts and variants failed for RSS feed "+r),this.getFallbackArticles(r,"所有RSS源均无法访问")}extractArticles(e){let n=[];try{let t=e.querySelectorAll("item");return(this.log(`Found ${t.length} RSS items`),0===t.length&&(t=e.querySelectorAll("entry"),this.log(`Found ${t.length} Atom entries`)),0===t.length)?(this.warn("No RSS items or Atom entries found"),[]):(t.forEach((t,e)=>{try{var r=this.extractArticleData(t,e);r&&n.push(r)}catch(t){console.error(`Failed to process item ${e+1}:`,t)}}),this.log(`Successfully extracted ${n.length} articles`),n.slice(0,10))}catch(t){return console.error("Error extracting articles:",t),[]}}extractArticleData(i,a){try{this.log(`Extracting article ${a+1}:`,i.tagName);var o=this.getTextContent(i,"title")||"Article "+(a+1),c=(this.log("  Title: "+o),this.getLinkHref(i));this.log("  Link: "+c);let e=null;try{e=this.getTextContent(i,"description")||this.getTextContent(i,"summary")||this.getTextContent(i,"content:encoded")||this.getTextContent(i,"content")}catch(t){this.warn("Error getting description:",t),e="No description available"}let t=null;try{t=this.getTextContent(i,"pubDate")||this.getTextContent(i,"published")||this.getTextContent(i,"updated")||this.getTextContent(i,"dc:date")}catch(t){this.warn("Error getting publication date:",t)}let r=null;try{r=this.getAuthor(i),this.log("  Author: "+r)}catch(t){this.warn("Error getting author:",t)}let n=null;try{n=this.getImage(i)}catch(t){this.warn("Error getting image:",t)}let s=null;try{s=this.getCategory(i)}catch(t){this.warn("Error getting category:",t)}var l={id:`article_${Date.now()}_`+a,title:this.cleanText(o),abstract:this.cleanText(e),link:c,publishDate:(t?new Date(t):new Date).toISOString(),authors:r||"Multiple Authors",image:n,category:s,journal:this.extractJournalName(i)};return this.log("  Successfully extracted article:",l.title),l}catch(t){return console.error(`Error extracting article data for item ${a+1}:`,t),this.log("Item details:",{tagName:i.tagName,innerHTML:i.innerHTML.substring(0,200)+"..."}),{id:`fallback_article_${Date.now()}_`+a,title:`Article ${a+1} (解析失败)`,abstract:"文章解析时发生错误，请点击链接查看原文。",link:this.extractFallbackLink(i),publishDate:(new Date).toISOString(),authors:"Unknown",image:null,category:"Error",journal:"Unknown",isError:!0}}}extractFallbackLink(t){try{var e;for(e of t.querySelectorAll("*")){if(e.textContent&&e.textContent.startsWith("http"))return e.textContent.trim();if(e.getAttribute("href"))return e.getAttribute("href");if(e.getAttribute("url"))return e.getAttribute("url")}}catch(t){this.warn("Failed to extract fallback link:",t)}return"#"}getTextContent(e,r){try{var t;if(r.includes(":")){var n,[,s]=r.split(":");let t=null;try{var i=e.getElementsByTagName(r);t=0<i.length?i[0]:null}catch(t){}if(!t)try{var a=e.getElementsByTagName(s);t=0<a.length?a[0]:null}catch(t){}if(!t)try{var o=e.getElementsByTagNameNS("*",s);t=0<o.length?o[0]:null}catch(t){}if(!t)try{for(n of e.querySelectorAll("*"))if(n.localName===s||n.tagName===r||n.tagName.toLowerCase()===r.toLowerCase()||n.tagName.endsWith(":"+s)){t=n;break}}catch(t){}return t?t.textContent.trim():null}return(t=this.safeQuerySelector(e,r))?t.textContent.trim():null}catch(t){return this.warn(`Error getting text content for ${r}:`,t),null}}safeQuerySelector(t,e){try{return t.querySelector(e)}catch(t){return this.warn("Invalid selector: "+e,t),null}}getNamespacedElement(t,e){try{var r=t.getElementsByTagName(e);if(0<r.length)return r[0];if(e.includes(":")){var n,s=e.split(":")[1],i=t.getElementsByTagName(s);if(0<i.length)return i[0];for(n of t.querySelectorAll("*"))if(n.localName===s||n.tagName.endsWith(":"+s))return n}return null}catch(t){return this.warn(`Error finding element ${e}:`,t),null}}getLinkHref(t){let e=this.safeQuerySelector(t,"link");var r;return e&&e.textContent&&e.textContent.trim().startsWith("http")?e.textContent.trim():(e=this.safeQuerySelector(t,'link[rel="alternate"]'))&&e.getAttribute("href")||(e=this.safeQuerySelector(t,"link[href]"))&&e.getAttribute("href")?e.getAttribute("href"):(r=this.safeQuerySelector(t,"guid"))&&r.textContent&&r.textContent.startsWith("http")?r.textContent.trim():(r=this.safeQuerySelector(t,"id"))&&r.textContent&&r.textContent.startsWith("http")?r.textContent.trim():"#"}getAuthor(t){var e;for(e of["author","dc:creator","creator","managingEditor"]){var r=this.getTextContent(t,e);if(r)return this.cleanAuthorName(r)}var n=this.safeQuerySelector(t,"author name");return n?n.textContent.trim():(n=this.safeQuerySelector(t,"author"))&&n.textContent?this.cleanAuthorName(n.textContent):null}cleanAuthorName(t){if(!t)return null;let e=t.replace(/\([^)]*@[^)]*\)/g,"");return e=100<(e=e.replace(/\s+/g," ").trim()).length?e.substring(0,100)+"...":e}getImage(t){var e=this.safeQuerySelector(t,'enclosure[type^="image"]');if(e)return e.getAttribute("url");e=this.getNamespacedElement(t,"media:content")||this.safeQuerySelector(t,'content[type^="image"]');if(e)return e.getAttribute("url");e=this.getTextContent(t,"description")||this.getTextContent(t,"content:encoded")||this.getTextContent(t,"summary");if(e){e=e.match(/<img[^>]+src=["']([^"']+)["']/i);if(e)return e[1]}e=this.getNamespacedElement(t,"media:thumbnail")||this.safeQuerySelector(t,"thumbnail")||this.safeQuerySelector(t,"image");return e?e.getAttribute("url")||e.getAttribute("src")||e.textContent:null}getCategory(t){var e;for(e of["category","dc:subject","subject"]){var r=this.getTextContent(t,e);if(r)return r}var n=this.safeQuerySelector(t,"category");return n?n.getAttribute("domain")||n.textContent:null}extractJournalName(t){var e=this.getTextContent(t,"source");return e||((e=this.getLinkHref(t)).includes("nature.com")?"Nature":e.includes("science.org")?"Science":e.includes("agupubs")?"AGU":"Journal")}cleanText(t){return t?t.replace(/<[^>]*>/g,"").replace(/\s+/g," ").trim().substring(0,500):""}getCached(t){t=this.cache.get(t);return t&&Date.now()-t.timestamp<this.cacheTimeout?t.data:null}setCache(t,e){this.cache.set(t,{data:e,timestamp:Date.now()})}getFallbackArticles(t,e="网络连接问题"){var r=this.getJournalNameFromUrl(t);return[{id:`fallback_${Date.now()}_1`,title:r+" - 暂时无法获取内容",abstract:`由于${e}，暂时无法获取最新文章。系统将自动重试，您也可以稍后刷新页面或直接访问期刊官网获取最新内容。`,link:this.getJournalHomepage(t),publishDate:(new Date).toISOString(),authors:"System Notice",image:null,category:"Notice",journal:r,isFallback:!0,errorMessage:e}]}getJournalNameFromUrl(t){return t.includes("nature.com/nature")?"Nature":t.includes("nature.com/nclimate")?"Nature Climate Change":t.includes("nature.com/ngeo")?"Nature Geoscience":t.includes("science.org")&&t.includes("jc=science")?"Science":t.includes("science.org")&&t.includes("jc=sciadv")?"Science Advances":t.includes("science.org")&&t.includes("news_current")?"Science News":t.includes("agupubs")&&t.includes("19448007")?"Geophysical Research Letters":t.includes("agupubs")&&t.includes("21698996")?"JGR: Atmospheres":t.includes("agupubs")&&t.includes("19422466")?"Reviews of Geophysics":t.includes("ametsoc")&&(t.includes("atsc")||t.includes("journals/atsc"))?"Journal of Atmospheric Sciences":t.includes("ametsoc")&&(t.includes("clim")||t.includes("journals/clim"))?"Journal of Climate":t.includes("sciencedirect.com")&&t.includes("0012821X")?"Earth and Planetary Science Letters":t.includes("acp.copernicus.org")?"Atmospheric Chemistry and Physics":t.includes("link.springer.com")&&t.includes("journal-id=382")?"Climate Dynamics":"Unknown Journal"}getJournalHomepage(t){var e,r;for([e,r]of Object.entries({"nature.com/nature":"https://www.nature.com/","nature.com/nclimate":"https://www.nature.com/nclimate/","nature.com/ngeo":"https://www.nature.com/ngeo/","science.org":"https://www.science.org/",agupubs:"https://agupubs.onlinelibrary.wiley.com/",ametsoc:"https://journals.ametsoc.org/",springer:"https://link.springer.com/"}))if(t.includes(e))return r;return"#"}extractScienceArticleData(t,e){try{var r=this.getTextContent(t,"title")||"Article "+(e+1),n=this.getLinkHref(t),s=this.getTextContent(t,"description")||this.getTextContent(t,"summary")||this.getTextContent(t,"content:encoded")||this.getTextContent(t,"content"),i=this.getTextContent(t,"pubDate")||this.getTextContent(t,"published")||this.getTextContent(t,"updated")||this.getTextContent(t,"dc:date"),a=this.getTextContent(t,"author")||this.getTextContent(t,"dc:creator")||this.getTextContent(t,"creator")||this.extractAuthorFromDescription(s),o=this.getImage(t),c=this.getCategory(t)||this.extractCategoryFromUrl(n);return{id:`article_${Date.now()}_`+e,title:this.cleanText(r),abstract:this.cleanText(s),link:n,publishDate:(i?new Date(i):new Date).toISOString(),authors:a||"Multiple Authors",image:o,category:c,journal:this.extractJournalName(t)}}catch(t){return console.error("Error extracting Science article data:",t),null}}extractAuthorFromDescription(t){if(t){var e;for(e of[/By\s+([^,\n]+)/i,/Author[s]?:\s*([^,\n]+)/i,/([A-Z][a-z]+\s+[A-Z][a-z]+(?:\s+et\s+al\.?)?)/]){var r=t.match(e);if(r)return r[1].trim()}}return null}extractCategoryFromUrl(t){return t.includes("climate")?"Climate Science":t.includes("geophys")?"Geophysics":t.includes("atmos")?"Atmospheric Science":t.includes("earth")?"Earth Science":null}setDebugMode(t){this.debug=t,this.log("Debug mode "+(t?"enabled":"disabled"))}getRSSVariants(t){var e=[t];return t.includes("journals.ametsoc.org")&&t.includes("showFeed")?t.includes("jc=atsc")?e.push("https://journals.ametsoc.org/journalissuetocrss/journals/atsc/atsc-overview.xml"):t.includes("jc=clim")&&e.push("https://journals.ametsoc.org/journalissuetocrss/journals/clim/clim-overview.xml"):t.includes("agupubs.onlinelibrary.wiley.com")?t.includes("19448007")?t.includes("/rss/journal/")?e.push("https://agupubs.onlinelibrary.wiley.com/action/showFeed?jc=19448007&type=etoc&feed=rss"):e.push("https://agupubs.onlinelibrary.wiley.com/rss/journal/19448007"):t.includes("21698996")?t.includes("/rss/journal/")?e.push("https://agupubs.onlinelibrary.wiley.com/action/showFeed?jc=21698996&type=etoc&feed=rss"):e.push("https://agupubs.onlinelibrary.wiley.com/rss/journal/21698996"):t.includes("19422466")&&t.includes("showFeed")&&e.push("https://agupubs.onlinelibrary.wiley.com/rss/journal/19422466"):t.includes("nature.com")?t.includes("nature.rss")?e.push("https://feeds.nature.com/nature/rss/current"):t.includes("ngeo.rss")?e.push("https://feeds.nature.com/ngeo/rss/current"):t.includes("nclimate.rss")&&e.push("https://feeds.nature.com/nclimate/rss/current"):t.includes("science.org")&&(t.includes("jc=science")?e.push("https://science.sciencemag.org/rss/current.xml"):t.includes("jc=sciadv")&&e.push("https://advances.sciencemag.org/rss/current.xml")),this.log(`Generated ${e.length} RSS variants for `+t),e}}window.rssParser=new RSSParser;