function initImageEnhancements(){setupIntelligentImageFit(),setupImageLazyLoading(),setupImagePreview(),setupImageErrorHandling(),setupSkeletonLoading()}function setupIntelligentImageFit(){document.querySelectorAll(".card-image img").forEach(e=>{e.complete&&0!==e.naturalHeight?applyIntelligentFit(e):e.addEventListener("load",()=>applyIntelligentFit(e))})}function applyIntelligentFit(e){var t=e.naturalWidth/e.naturalHeight;e.classList.remove("fit-cover","fit-contain","fit-fill"),isChartOrDiagram(e)?(e.classList.add("fit-contain"),e.style.objectFit="contain",e.style.background="white",e.style.padding="10px"):2<t||t<.5?(e.classList.add("fit-contain"),e.style.objectFit="contain",e.style.background="var(--bg-gray-50)"):Math.abs(t-1.5)<.3?(e.classList.add("fit-cover"),e.style.objectFit="cover",e.style.objectPosition="center"):(e.classList.add("fit-cover"),e.style.objectFit="cover",e.style.objectPosition=getSmartObjectPosition(e,t))}function isChartOrDiagram(e){let t=e.src.toLowerCase(),a=e.alt.toLowerCase();return["chart","graph","plot","diagram","figure","mrg","cckws","scale"].some(e=>t.includes(e)||a.includes(e))}function getSmartObjectPosition(e,t){return 1.8<t?"center top":"center center"}function setupImageLazyLoading(){if("IntersectionObserver"in window){let t=new IntersectionObserver((e,t)=>{e.forEach(e=>{e.isIntersecting&&(loadImage(e=e.target),t.unobserve(e))})},{rootMargin:"50px"});document.querySelectorAll(".card-image img[data-src]").forEach(e=>{t.observe(e)})}else document.querySelectorAll(".card-image img[data-src]").forEach(loadImage)}function loadImage(e){e.dataset.src&&(e.src=e.dataset.src,e.classList.add("loading"),e.addEventListener("load",()=>{e.classList.remove("loading"),e.classList.add("loaded"),applyIntelligentFit(e)}),e.addEventListener("error",()=>{e.classList.remove("loading"),e.classList.add("error"),handleImageError(e)}))}function setupImageErrorHandling(){document.querySelectorAll(".card-image img").forEach(e=>{e.addEventListener("error",()=>handleImageError(e))})}function handleImageError(e){var t=e.closest(".card-image");t&&(e=createImageFallback((e=e.closest(".blog-post-card"))?e.dataset.category:""),t.innerHTML="",t.appendChild(e),t.classList.add("placeholder"))}function createImageFallback(e){var t=document.createElement("div");t.className="image-fallback";let a="fas fa-image",n="linear-gradient(135deg, #6b7280, #9ca3af)";switch(e){case"科研":a="fas fa-microscope",n="linear-gradient(135deg, #8b5cf6, #a855f7)";break;case"技术":a="fas fa-code",n="linear-gradient(135deg, #3b82f6, #2563eb)";break;case"杂谈":a="fas fa-coffee",n="linear-gradient(135deg, #f59e0b, #f97316)"}return t.innerHTML=`
        <div class="fallback-icon">
            <i class="${a}"></i>
        </div>
        <span class="fallback-text">${e||"文章"}</span>
    `,t.style.background=n,t}function setupImagePreview(){document.querySelectorAll(".card-image img").forEach(t=>{t.addEventListener("click",e=>{e.stopPropagation(),openImagePreview(t)})})}function openImagePreview(e){var t,a,n=document.getElementById("imageModal");n&&(t=n.querySelector(".modal-image"),a=n.querySelector(".modal-title"),t)&&a&&(t.src=e.src,a.textContent=e.alt||"图片预览",n.style.display="flex",document.body.style.overflow="hidden",n.addEventListener("click",closeImagePreview),document.addEventListener("keydown",handleEscapeKey))}function closeImagePreview(){var e=document.getElementById("imageModal");e&&(e.style.display="none",document.body.style.overflow="",e.removeEventListener("click",closeImagePreview),document.removeEventListener("keydown",handleEscapeKey))}function handleEscapeKey(e){"Escape"===e.key&&closeImagePreview()}function setupSkeletonLoading(){document.querySelectorAll(".card-image img").forEach(t=>{if(!t.complete){let e=createImageSkeleton();t.closest(".card-image").insertBefore(e,t),t.addEventListener("load",()=>{e.remove()}),t.addEventListener("error",()=>{e.remove()})}})}function createImageSkeleton(){var e=document.createElement("div");return e.className="image-skeleton",e.innerHTML=`
        <div class="skeleton-animation"></div>
    `,e}function debounce(t,a){let n;return function(...e){clearTimeout(n),n=setTimeout(()=>{clearTimeout(n),t(...e)},a)}}document.addEventListener("DOMContentLoaded",function(){initImageEnhancements()}),window.addEventListener("resize",debounce(()=>{setupIntelligentImageFit()},250)),window.BlogImageEnhancer={refresh:initImageEnhancements,applyIntelligentFit:setupIntelligentImageFit,handleError:handleImageError};