class LinksManager{constructor(){this.allLinks=[],this.currentFilter="all",this.currentSort="default",this.searchQuery="",this.searchHistory=this.loadSearchHistory(),this.init()}init(){this.cacheElements(),this.bindEvents(),this.indexLinks(),this.updateDisplay()}cacheElements(){this.searchInput=document.getElementById("searchInput"),this.clearSearch=document.getElementById("clearSearch"),this.searchSuggestions=document.getElementById("searchSuggestions"),this.sortSelect=document.getElementById("sortSelect"),this.resultsInfo=document.getElementById("resultsInfo"),this.resultsText=document.getElementById("resultsText"),this.noResults=document.getElementById("noResults"),this.linksGrid=document.getElementById("linksGrid"),this.filterButtons=document.querySelectorAll(".filter-btn"),this.categorySections=document.querySelectorAll(".category-section"),this.linkCards=document.querySelectorAll(".link-card")}bindEvents(){this.searchInput.addEventListener("input",e=>{this.handleSearch(e.target.value)}),this.searchInput.addEventListener("focus",()=>{this.showSearchSuggestions()}),this.searchInput.addEventListener("blur",()=>{setTimeout(()=>this.hideSearchSuggestions(),200)}),this.searchInput.addEventListener("keydown",e=>{this.handleSearchKeyboard(e)}),this.clearSearch.addEventListener("click",()=>{this.clearSearch()}),this.filterButtons.forEach(e=>{e.addEventListener("click",e=>{this.handleFilter(e.target.closest(".filter-btn").dataset.category)})}),this.sortSelect.addEventListener("change",e=>{this.handleSort(e.target.value)}),document.addEventListener("keydown",e=>{"Escape"===e.key?this.clearAllFilters():"/"!==e.key||e.target.matches("input, textarea")||(e.preventDefault(),this.searchInput.focus())})}handleSearchKeyboard(e){var t,s=this.searchSuggestions.querySelectorAll(".suggestion-item"),r=this.searchSuggestions.querySelector(".suggestion-item.active");let i=r?Array.from(s).indexOf(r):-1;switch(e.key){case"ArrowDown":e.preventDefault(),i=Math.min(i+1,s.length-1),this.highlightSuggestion(s,i);break;case"ArrowUp":e.preventDefault(),i=Math.max(i-1,-1),this.highlightSuggestion(s,i);break;case"Enter":e.preventDefault(),r?(t=r.querySelector("span").textContent,this.applySuggestion(t)):1<this.searchQuery.length&&(this.addToSearchHistory(this.searchQuery),this.hideSearchSuggestions());break;case"Escape":this.hideSearchSuggestions(),this.searchInput.blur()}}highlightSuggestion(e,s){e.forEach((e,t)=>{e.classList.toggle("active",t===s)})}indexLinks(){this.allLinks=Array.from(this.linkCards).map(e=>({element:e,name:e.dataset.name||"",url:e.dataset.url||"",category:e.dataset.category||"",group:e.dataset.group||"",title:e.querySelector(".link-title")?.textContent||"",description:e.querySelector(".link-description")?.textContent||"",domain:e.querySelector(".link-domain")?.textContent||""}))}handleSearch(e){this.searchQuery=e.toLowerCase().trim(),this.clearSearch.style.display=this.searchQuery?"flex":"none",this.updateDisplay(),this.updateSearchSuggestions()}handleFilter(t){this.currentFilter=t,this.filterButtons.forEach(e=>{e.classList.toggle("active",e.dataset.category===t)}),this.updateDisplay()}handleSort(e){this.currentSort=e,this.updateDisplay()}updateDisplay(){var e=this.filterLinks(),e=this.sortLinks(e);this.showFilteredLinks(e),this.updateResultsInfo(e.length),this.updateCategorySections(e),this.updateVisibleCount(e.length)}updateVisibleCount(e){var t=document.getElementById("visibleCount");t&&(t.textContent=e)}filterLinks(){return this.allLinks.filter(e=>{var t="all"===this.currentFilter||e.category===this.currentFilter,e=!this.searchQuery||this.matchesSearch(e);return t&&e})}matchesSearch(e){var t=this.searchQuery.split(" ").filter(e=>0<e.length);let s=(e.name+` ${e.title} ${e.description} ${e.group} `+e.domain).toLowerCase();return t.every(e=>s.includes(e))}sortLinks(e){switch(this.currentSort){case"name":return[...e].sort((e,t)=>e.title.localeCompare(t.title));case"category":return[...e].sort((e,t)=>e.group.localeCompare(t.group));default:return e}}showFilteredLinks(e){let s=new Set(e.map(e=>e.element));this.allLinks.forEach(e=>{var t=s.has(e.element);e.element.style.display=t?"block":"none",t&&(e.element.style.animation="fadeInUp 0.3s ease forwards")}),this.noResults.style.display=0===e.length?"block":"none"}updateCategorySections(r){let i=new Set(r.map(e=>e.category));this.categorySections.forEach(e=>{let t=e.dataset.category;i.has(t)||this.currentFilter;var s=r.filter(e=>e.category===t);this.searchQuery||"all"!==this.currentFilter?e.style.display=0<s.length?"block":"none":e.style.display="block"})}updateResultsInfo(t){if(this.searchQuery||"all"!==this.currentFilter){this.resultsInfo.style.display="block";let e=`找到 ${t} 个结果`;this.searchQuery&&(e+=` (搜索: "${this.searchQuery}")`),"all"!==this.currentFilter&&(t=document.querySelector(`[data-category="${this.currentFilter}"]`)?.textContent.replace(/\d+/g,"").trim()||this.currentFilter,e+=` (分类: ${t})`),this.resultsText.textContent=e}else this.resultsInfo.style.display="none"}updateSearchSuggestions(){var e;this.searchQuery&&0<(e=this.generateSuggestions()).length?this.showSearchSuggestions(e):this.hideSearchSuggestions()}generateSuggestions(){let t=new Set;return!this.searchQuery&&0<this.searchHistory.length?(this.searchHistory.slice(0,5).forEach(e=>t.add(e)),Array.from(t)):(this.searchHistory.forEach(e=>{e.toLowerCase().includes(this.searchQuery)&&t.add(e)}),["ENSO","预测","卫星","模式","数据","气候","Python","季风","波动","论文","监测","NOAA","NASA"].forEach(e=>{(e.toLowerCase().includes(this.searchQuery)||e.toLowerCase().startsWith(this.searchQuery))&&t.add(e)}),this.allLinks.forEach(e=>{e.title.toLowerCase().includes(this.searchQuery)&&t.add(e.title),e.group.toLowerCase().includes(this.searchQuery)&&t.add(e.group),e.description&&e.description.split(/[\s\u3000\uff0c\u3001\uff1a\uff1b]+/).forEach(e=>{2<(e=e.replace(/[^\w\u4e00-\u9fff]/g,"")).length&&e.toLowerCase().includes(this.searchQuery)&&t.add(e)}),e.domain&&e.domain.includes(this.searchQuery)&&t.add(e.domain)}),Array.from(t).sort((e,t)=>{var s=e.toLowerCase(),r=t.toLowerCase(),i=this.searchQuery;return this.searchHistory.includes(e)&&!this.searchHistory.includes(t)?-1:this.searchHistory.includes(t)&&!this.searchHistory.includes(e)?1:s===i&&r!==i?-1:r===i&&s!==i?1:s.startsWith(i)&&!r.startsWith(i)?-1:r.startsWith(i)&&!s.startsWith(i)?1:e.length-t.length}).slice(0,8))}showSearchSuggestions(e=[]){0===e.length?this.hideSearchSuggestions():(e=e.map(e=>{var t=this.searchHistory.includes(e);return`<div class="suggestion-item ${t?"history-item":""}" onclick="linksManager.applySuggestion('${e}')">
                <i class="${t?"fas fa-history":"fas fa-search"}"></i>
                <span>${this.highlightQuery(e)}</span>
                ${t?'<span class="suggestion-label">历史</span>':""}
            </div>`}).join(""),this.searchSuggestions.innerHTML=e,this.searchSuggestions.style.display="block")}hideSearchSuggestions(){this.searchSuggestions.style.display="none"}applySuggestion(e){this.searchInput.value=e,this.handleSearch(e),this.addToSearchHistory(e),this.hideSearchSuggestions(),this.searchInput.blur()}addToSearchHistory(t){!t||t.length<2||(this.searchHistory=this.searchHistory.filter(e=>e!==t),this.searchHistory.unshift(t),this.searchHistory=this.searchHistory.slice(0,10),localStorage.setItem("linksSearchHistory",JSON.stringify(this.searchHistory)))}loadSearchHistory(){try{var e=localStorage.getItem("linksSearchHistory");return e?JSON.parse(e):[]}catch(e){return[]}}highlightQuery(e){var t;return this.searchQuery?(t=new RegExp(`(${this.searchQuery})`,"gi"),e.replace(t,"<mark>$1</mark>")):e}clearSearch(){this.searchInput.value="",this.searchQuery="",this.clearSearch.style.display="none",this.hideSearchSuggestions(),this.updateDisplay()}clearAllFilters(){this.clearSearch(),this.handleFilter("all"),this.handleSort("default"),this.sortSelect.value="default"}getStats(){var e=this.filterLinks();return{total:this.allLinks.length,categories:new Set(this.allLinks.map(e=>e.category)).size,currentVisible:e.length,searchQuery:this.searchQuery,currentFilter:this.currentFilter}}exportResults(){var e=this.filterLinks().map(e=>({name:e.title,url:e.element.href,category:e.group,description:e.description||"",domain:e.domain})),e=this.convertToCSV(e),e=new Blob([e],{type:"text/csv;charset=utf-8;"}),t=document.createElement("a"),s=`学术链接_${"all"===this.currentFilter?"全部":this.currentFilter}_${(new Date).toISOString().slice(0,10)}.csv`;navigator.msSaveBlob?navigator.msSaveBlob(e,s):(t.href=URL.createObjectURL(e),t.download=s,t.style.visibility="hidden",document.body.appendChild(t),t.click(),document.body.removeChild(t))}convertToCSV(e){return"\ufeff"+[["名称","URL","分类","描述","域名"].join(","),...e.map(e=>[`"${e.name}"`,`"${e.url}"`,`"${e.category}"`,`"${e.description}"`,`"${e.domain}"`].join(","))].join("\n")}randomLink(){var t=this.filterLinks();if(0===t.length)alert("没有可用的链接");else{let e=t[Math.floor(Math.random()*t.length)];e.element.style.transform="scale(1.05)",e.element.style.boxShadow="0 8px 25px rgba(102, 126, 234, 0.3)",setTimeout(()=>{e.element.style.transform="",e.element.style.boxShadow="",window.open(e.element.href,"_blank")},500)}}}function clearAllFilters(){window.linksManager&&window.linksManager.clearAllFilters()}document.addEventListener("DOMContentLoaded",()=>{window.linksManager=new LinksManager,console.log("Links Manager 已初始化"),console.log("快捷键: ESC - 清除所有筛选")});let style=document.createElement("style");style.textContent=`
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.suggestion-item {
    padding: 8px 12px;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: background-color 0.2s ease;
}

.suggestion-item:hover {
    background-color: var(--bg-secondary, #f8f9fa);
}

.suggestion-item i {
    color: var(--text-muted, #6c757d);
    font-size: 12px;
}

.suggestion-item mark {
    background-color: var(--primary-color, #007bff);
    color: white;
    padding: 1px 3px;
    border-radius: 2px;
}
`,document.head.appendChild(style);