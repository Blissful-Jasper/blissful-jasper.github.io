---
layout: page
title: Gallery Test - 原图查看测试
permalink: /gallery-test-original.html
---

<link rel="stylesheet" href="{{ '/assets/gallery-page.css' | relative_url }}">

<div class="gallery-container">
  <div class="gallery-header">
    <div class="header-content">
      <h1 class="page-title">
        <i class="fas fa-camera"></i>
        原图查看功能测试
      </h1>
      <p class="page-subtitle">测试新的原图查看器功能</p>
    </div>
  </div>

  <!-- 测试图片网格 -->
  <div class="gallery-grid">
    {% for category in site.data.gallery limit:1 %}
      {% for photo in category.photos limit:3 %}
        <div class="gallery-item" data-category="{{ category.id }}">
          <div class="photo-wrapper">
            <div class="photo-container">
              <img src="{{ photo.image | relative_url }}" 
                   alt="{{ photo.title }}" 
                   loading="lazy"
                   onerror="handleImageError(this, '{{ photo.image }}')">
              <div class="photo-overlay">
                <div class="photo-info">
                  <h3 class="photo-title">{{ photo.title }}</h3>
                  <p class="photo-description">{{ photo.description }}</p>
                  <div class="photo-meta">
                    {% if photo.location %}
                      <span class="meta-item">
                        <i class="fas fa-map-marker-alt"></i>
                        {{ photo.location }}
                      </span>
                    {% endif %}
                    {% if photo.date %}
                      <span class="meta-item">
                        <i class="fas fa-calendar"></i>
                        {{ photo.date }}
                      </span>
                    {% endif %}
                  </div>
                </div>
              </div>
              <div class="photo-actions">
                <button class="action-btn view-btn" 
                        data-image="{{ photo.image | relative_url }}"
                        data-title="{{ photo.title | escape }}"
                        data-description="{{ photo.description | escape }}"
                        data-original="{{ photo.image }}"
                        data-location="{{ photo.location | escape }}"
                        data-date="{{ photo.date | escape }}"
                        data-camera="{{ photo.camera | escape }}"
                        data-tags="{{ photo.tags | join: ',' | escape }}"
                        onclick="openLightboxFromButton(this)">
                  <i class="fas fa-expand"></i>
                  <span class="btn-text">查看</span>
                </button>
                <button class="action-btn share-btn" 
                        data-title="{{ photo.title | escape }}"
                        data-image="{{ photo.image | absolute_url }}"
                        onclick="sharePhotoFromButton(this)">
                  <i class="fas fa-share-alt"></i>
                  <span class="btn-text">分享</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      {% endfor %}
    {% endfor %}
  </div>

  <!-- 测试按钮 -->
  <div style="text-align: center; margin: 40px 0; padding: 20px; background: rgba(255,255,255,0.9); border-radius: 15px;">
    <h3>测试功能</h3>
    <p>点击上面的图片"查看"按钮，然后在灯箱中点击"原图"按钮测试新的原图查看器功能。</p>
    <div style="margin-top: 20px;">
      <button onclick="testOriginalViewer()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 25px; cursor: pointer; margin: 5px;">
        直接测试原图查看器
      </button>
      <button onclick="testImagePaths()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 25px; cursor: pointer; margin: 5px;">
        测试图片路径
      </button>
      <button onclick="showDebugInfo()" style="padding: 10px 20px; background: #ffc107; color: black; border: none; border-radius: 25px; cursor: pointer; margin: 5px;">
        显示调试信息
      </button>
    </div>
    <div id="debugInfo" style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; text-align: left; font-family: monospace; font-size: 14px; display: none;"></div>
  </div>
</div>

<!-- 灯箱模态框 -->
<div id="lightbox" class="lightbox">
  <div class="lightbox-overlay" onclick="closeLightbox()"></div>
  <div class="lightbox-content">
    <div class="lightbox-header">
      <div class="lightbox-controls">
        <button class="control-btn" id="viewOriginalBtn" onclick="viewOriginalImage()" title="查看原图">
          <i class="fas fa-expand-arrows-alt"></i>
          <span>原图</span>
        </button>
        <button class="control-btn" id="downloadBtn" onclick="downloadImage()" title="下载图片">
          <i class="fas fa-download"></i>
          <span>下载</span>
        </button>
        <button class="control-btn" id="shareBtn" onclick="shareCurrentImage()" title="分享图片">
          <i class="fas fa-share-alt"></i>
          <span>分享</span>
        </button>
      </div>
      <button class="lightbox-close" onclick="closeLightbox()" title="关闭">
        <i class="fas fa-times"></i>
      </button>
    </div>
    
    <div class="lightbox-image-container">
      <img id="lightbox-image" src="" alt="" loading="lazy">
      <div class="image-loading" id="imageLoading">
        <i class="fas fa-spinner fa-spin"></i>
        <span>加载中...</span>
      </div>
    </div>
    
    <div class="lightbox-info">
      <div class="info-content">
        <h3 id="lightbox-title">图片标题</h3>
        <p id="lightbox-description">图片描述</p>
        <div class="image-meta" id="lightbox-meta">
          <!-- 元数据信息将通过JavaScript填充 -->
        </div>
      </div>
      <div class="image-actions">
        <button class="action-button zoom-in" onclick="zoomImage(1.2)" title="放大">
          <i class="fas fa-search-plus"></i>
        </button>
        <button class="action-button zoom-out" onclick="zoomImage(0.8)" title="缩小">
          <i class="fas fa-search-minus"></i>
        </button>
        <button class="action-button zoom-reset" onclick="resetZoom()" title="重置">
          <i class="fas fa-compress"></i>
        </button>
      </div>
    </div>
  </div>
</div>

<script src="{{ '/assets/gallery-page.js' | relative_url }}"></script>

<script>
// 测试函数
function testOriginalViewer() {
  // 模拟图片数据
  window.currentImageData = {
    src: '/pictures/DSC_1667.JPG',
    title: '测试图片',
    description: '这是一张测试图片，用于测试原图查看器功能',
    originalPath: '/pictures/DSC_1667.JPG',
    thumbnail: '/pictures/DSC_1667.JPG',
    metadata: {
      location: '测试地点',
      date: '2024-01-01',
      camera: 'Canon EOS',
      tags: '测试,原图,查看器'
    }
  };
  
  console.log('Test data set:', window.currentImageData);
  
  // 直接调用原图查看器
  viewOriginalImage();
}

// 测试图片路径
function testImagePaths() {
  const testPaths = [
    '/pictures/DSC_1667.JPG',
    '/pictures/DSC_1573.jpg',
    '/pictures/DSC_1354.jpg'
  ];
  
  const debugDiv = document.getElementById('debugInfo');
  debugDiv.style.display = 'block';
  debugDiv.innerHTML = '<h4>测试图片路径:</h4>';
  
  testPaths.forEach((path, index) => {
    const fullUrl = window.location.origin + path;
    debugDiv.innerHTML += `<div>测试 ${index + 1}: <a href="${fullUrl}" target="_blank">${fullUrl}</a></div>`;
    
    // 测试图片是否可访问
    const img = new Image();
    img.onload = function() {
      debugDiv.innerHTML += `<div style="color: green;">✓ ${path} - 加载成功 (${this.width}x${this.height})</div>`;
    };
    img.onerror = function() {
      debugDiv.innerHTML += `<div style="color: red;">✗ ${path} - 加载失败</div>`;
    };
    img.src = fullUrl;
  });
}

// 显示调试信息
function showDebugInfo() {
  const debugDiv = document.getElementById('debugInfo');
  debugDiv.style.display = 'block';
  
  const info = {
    'Current URL': window.location.href,
    'Base URL': window.location.origin,
    'Pathname': window.location.pathname,
    'User Agent': navigator.userAgent,
    'Gallery data available': typeof window.currentImageData !== 'undefined',
    'Gallery JS loaded': typeof viewOriginalImage === 'function'
  };
  
  let html = '<h4>调试信息:</h4>';
  for (const [key, value] of Object.entries(info)) {
    html += `<div><strong>${key}:</strong> ${value}</div>`;
  }
  
  if (window.currentImageData) {
    html += '<h4>当前图片数据:</h4>';
    html += `<pre>${JSON.stringify(window.currentImageData, null, 2)}</pre>`;
  }
  
  debugDiv.innerHTML = html;
}

/**
 * 从按钮的数据属性打开lightbox
 */
function openLightboxFromButton(button) {
  const imageSrc = button.dataset.image;
  const title = button.dataset.title;
  const description = button.dataset.description;
  const originalPath = button.dataset.original;
  const location = button.dataset.location;
  const date = button.dataset.date;
  const camera = button.dataset.camera;
  const tags = button.dataset.tags;
  
  const metadata = {
    location: location,
    date: date,
    camera: camera,
    tags: tags
  };
  
  const options = {
    originalPath: originalPath,
    thumbnail: imageSrc,
    metadata: metadata
  };
  
  console.log('Opening lightbox with:', { imageSrc, title, description, options });
  openLightbox(imageSrc, title, description, options);
}

/**
 * 从按钮的数据属性分享照片
 */
function sharePhotoFromButton(button) {
  const title = button.dataset.title;
  const imageUrl = button.dataset.image;
  sharePhoto(title, imageUrl);
}

// 图片错误处理函数
function handleImageError(img, originalSrc) {
  console.warn('Image failed to load:', img.src);
  
  // 尝试不同的路径
  const paths = [
    originalSrc,
    originalSrc.replace('/pictures/', '/assets/pictures/'),
    originalSrc.replace('/pictures/', '/_picture/'),
    originalSrc.replace('.JPG', '.jpg'),
    originalSrc.replace('.jpg', '.JPG')
  ];
  
  let currentIndex = 0;
  
  function tryNextPath() {
    currentIndex++;
    if (currentIndex < paths.length) {
      console.log('Trying alternative path:', paths[currentIndex]);
      img.src = paths[currentIndex];
    } else {
      // 所有路径都失败了，显示占位符
      img.style.display = 'none';
      img.parentElement.innerHTML += '<div class="image-placeholder"><i class="fas fa-image"></i><span>图片加载失败</span></div>';
    }
  }
  
  img.onerror = tryNextPath;
  tryNextPath();
}

// 分享功能
function sharePhoto(title, imageUrl) {
  console.log('Sharing photo:', title, imageUrl);
  
  if (navigator.share) {
    navigator.share({
      title: title,
      text: '查看这张美丽的照片',
      url: imageUrl
    }).catch(console.error);
  } else {
    navigator.clipboard.writeText(imageUrl).then(() => {
      alert('图片链接已复制到剪贴板');
    }).catch(() => {
      prompt('图片链接（请手动复制）:', imageUrl);
    });
  }
}

// 页面加载完成后的初始化
document.addEventListener('DOMContentLoaded', function() {
  console.log('Gallery test page loaded');
  console.log('Available functions:', {
    'openLightbox': typeof openLightbox === 'function',
    'viewOriginalImage': typeof viewOriginalImage === 'function',
    'closeLightbox': typeof closeLightbox === 'function'
  });
});
</script>

<style>
.image-placeholder {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 20px;
  background: rgba(0,0,0,0.05);
  color: #666;
  border-radius: 8px;
}

.image-placeholder i {
  font-size: 32px;
  margin-bottom: 10px;
  opacity: 0.5;
}
</style>
